name: pc-kernel
adopt-info: kernel
grade: stable
summary: generic linux kernel
description: The generic Ubuntu kernel package as a snap
type: kernel
confinement: strict
build-base: core20
# In addition to these repositories, the /+snap/ page on launchpad may
# also build with ESM repositories enabled, or built in a particular
# PPA, which will also be used.
package-repositories:
  - type: apt
    ppa: canonical-kernel-team/uc20-release
  - type: apt
    ppa: canonical-kernel-team/uc20-staging
  - type: apt
    ppa: canonical-kernel-team/proposed

parts:
  kernel:
    plugin: nil
    # Set this snap version to the meta version of the package used to
    # provide kernel.efi / vmlinuz
    override-pull: |
      snapcraftctl pull
      snapcraftctl set-version "$(apt show linux-image-uc20-efi-generic linux-image-generic 2>/dev/null | sed -n 's/^Version: //p' | head -n1)"
    build-packages:
      - kmod
    stage-packages:
      - try:
        - linux-image-uc20-efi-generic
      - else:
        - linux-image-generic
    organize:
      boot: ./
      lib/firmware: firmware
      lib/modules: modules
      usr/share/doc: doc
    override-build: |
      if [ -d "$SNAPCRAFT_PART_INSTALL"/usr/share/doc/linux-image-uc20-efi-generic ]; then
        rm -f "$SNAPCRAFT_PART_INSTALL"/boot/vmlinuz-*
        mv "$SNAPCRAFT_PART_INSTALL"/boot/kernel.efi-* "$SNAPCRAFT_PART_INSTALL"/boot/kernel.efi
      else
        mv "$SNAPCRAFT_PART_INSTALL"/boot/vmlinuz-* "$SNAPCRAFT_PART_INSTALL"/boot/vmlinuz
      fi
      snapcraftctl build
    # Exclude transitive dependencies of userspace stage-packages that
    # do not make sense in the kernel snap. E.g. iw tool is shipped in
    # base snap, but kernel needs to ship regulatory-db datafiles
    # alone.
    stage:
      - -etc
      - -lib
      - -usr
      - -sbin
      - -doc/crda
      - -doc/iw
      - -doc/linux-base
